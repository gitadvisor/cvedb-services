const { validationResult } = require('express-validator')
const errors = require('./error')
const error = new errors.CveIdControllerError()
const utils = require('../../utils/utils')

function parseGetParams (req, res, next) {
  utils.reqCtxMapping(req, 'query', ['page', 'state', 'cve_id_year', 'time_reserved.lt', 'time_reserved.gt', 'time_modified.lt', 'time_modified.gt'])
  utils.reqCtxMapping(req, 'params', ['id'])
  next()
}

function parsePostParams (req, res, next) {
  utils.reqCtxMapping(req, 'query', ['state', 'amount', 'batch_type', 'short_name', 'cve_year', 'org'])
  utils.reqCtxMapping(req, 'params', ['id', 'year'])
  next()
}

function parseError (req, res, next) {
  const err = validationResult(req).formatWith(({ location, msg, param, value, nestedErrors }) => {
    return { msg: msg, param: param, location: location }
  })
  if (!err.isEmpty()) {
    return res.status(400).json(error.badInput(err.array()))
  }
  next()
}

module.exports = {
  parseGetParams,
  parsePostParams,
  parseError
}
